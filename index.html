<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>PDF scroll continuo</title>
<style>
  :root { --bg: #fff; --page-gap: 16px; }
  html, body { margin:0; background:var(--bg); color:#111; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  header { position: sticky; top: 0; z-index: 10; background: #fff; border-bottom: 1px solid #eee; padding: 8px 12px; font-size:14px; }
  #status { opacity:.8 }
  #pages { max-width: 1000px; margin: 10px auto 40px; padding: 0 10px; }
  .page {
    display:block; margin: var(--page-gap) auto; padding: 0;
    background:#fff; border:1px solid #e5e7eb; border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
    overflow:hidden;
  }
  .page canvas { width:100%; height:auto; display:block; background:#fff; }
  .ph {
    width:100%; aspect-ratio: 1/1.4142; /* A-series ratio aproximado para placeholder */
    background: #f6f7f9;
  }
  .num {
    text-align:center; font-size:12px; color:#666; padding:6px 0 10px;
  }
  /* Ajustes para pantallas estrechas */
  @media (max-width: 900px){
    #pages { max-width: 100%; }
  }
</style>
</head>
<body>
  <header><span id="status">Cargando‚Ä¶</span></header>
  <main id="pages" aria-live="polite"></main>

  <!-- PDF.js (lib + worker) desde CDN) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js" integrity="sha512-Y+Z0Qw2XfWqLwQ/kK0+qX1v6e0n+3b0kD2xQF2oEDx8w3cFv7eQqG9A1U2v9XzKc3O1Vn5V2g9p5b1Gq4k4wQQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    // üëâ Cambia esto por tu archivo PDF (misma carpeta o URL absoluta):
    const PDF_URL = "ilovepdf_merged.pdf";

    // Configuraci√≥n del worker de PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    const pagesContainer = document.getElementById('pages');
    const statusEl = document.getElementById('status');

    let pdfDoc = null;
    let observers = [];
    let pageCanvases = new Map(); // pageNum -> {canvas, renderedScale}

    function setStatus(msg) { statusEl.textContent = msg; }

    // Crea el contenedor/placeholder para cada p√°gina
    function createPageShell(pageNum) {
      const section = document.createElement('section');
      section.className = 'page';
      section.setAttribute('data-page', pageNum);

      // Canvas real (se llena al renderizar)
      const canvas = document.createElement('canvas');
      // Placeholder mientras no se renderiza
      const ph = document.createElement('div');
      ph.className = 'ph';

      section.appendChild(canvas);
      const num = document.createElement('div');
      num.className = 'num';
      num.textContent = `P√°gina ${pageNum}`;
      section.appendChild(num);

      pagesContainer.appendChild(section);
      pageCanvases.set(pageNum, { canvas, renderedScale: 0 });
    }

    // Calcula escala para que la p√°gina ocupe el ancho disponible, con nitidez retina
    function computeScale(viewportWidth) {
      const containerWidth = Math.min(
        pagesContainer.clientWidth || window.innerWidth,
        1000 // ancho m√°ximo visual
      );
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      return (containerWidth / viewportWidth) * dpr;
    }

    async function renderPage(pageNum) {
      const { canvas } = pageCanvases.get(pageNum);
      const page = await pdfDoc.getPage(pageNum);

      // Viewport inicial a escala 1 para obtener dimensiones base
      const vp1 = page.getViewport({ scale: 1 });
      const scale = computeScale(vp1.width);
      // Evita re-render si ya est√° renderizado a escala similar (¬±5%)
      const prev = pageCanvases.get(pageNum).renderedScale || 0;
      if (prev && Math.abs(prev - scale) / scale < 0.05) return;

      const viewport = page.getViewport({ scale });
      const ctx = canvas.getContext('2d');

      canvas.width = Math.floor(viewport.width);
      canvas.height = Math.floor(viewport.height);
      canvas.style.width = Math.floor(viewport.width / (window.devicePixelRatio || 1)) + 'px';
      canvas.style.height = Math.floor(viewport.height / (window.devicePixelRatio || 1)) + 'px';

      // Fondo blanco para evitar ‚Äúp√°gina negra‚Äù en dark mode
      ctx.save();
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.restore();

      await page.render({ canvasContext: ctx, viewport }).promise;
      pageCanvases.get(pageNum).renderedScale = scale;
    }

    function setupLazyRendering(numPages) {
      // Observador que renderiza al entrar en viewport
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting) {
            const pageNum = Number(e.target.getAttribute('data-page'));
            renderPage(pageNum);
          }
        });
      }, { root: null, rootMargin: '500px 0px', threshold: 0.01 });

      // Observar todas las secciones
      const sections = pagesContainer.querySelectorAll('.page');
      sections.forEach(sec => io.observe(sec));
      observers.push(io);

      // Re-render en cambios de tama√±o (debounce)
      let t;
      window.addEventListener('resize', () => {
        clearTimeout(t);
        t = setTimeout(() => {
          for (let i=1; i<=numPages; i++) renderPage(i);
        }, 200);
      });
    }

    async function init() {
      try {
        setStatus('Cargando PDF‚Ä¶');
        const loadingTask = pdfjsLib.getDocument(PDF_URL);
        pdfDoc = await loadingTask.promise;

        setStatus(`P√°ginas: ${pdfDoc.numPages}. Preparando‚Ä¶`);
        // Crea shells
        for (let i = 1; i <= pdfDoc.numPages; i++) createPageShell(i);

        setupLazyRendering(pdfDoc.numPages);
        setStatus('Listo. Desliza para leer.');
      } catch (err) {
        console.error(err);
        setStatus('No se pudo cargar el PDF. Como alternativa, √°brelo directamente: ' + PDF_URL);
        // Enlace de respaldo
        const p = document.createElement('p');
        p.style.textAlign = 'center';
        p.innerHTML = `<a href="${PDF_URL}">Abrir/descargar PDF</a>`;
        pagesContainer.appendChild(p);
      }
    }

    init();
  </script>
</body>
</html>
